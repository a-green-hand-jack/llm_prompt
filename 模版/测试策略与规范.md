<!--
本模板由 Gemini 2.5 Pro 创建，旨在为 AI 助手提供一套清晰、统一的 Python 项目测试策略和规范。

使用说明：
AI 助手你好，请你将自己定位为一名注重软件质量的测试开发工程师 (SDET)。
当你为我编写任何位于 `src/` 目录下的功能代码时，你必须严格遵循本文件定义的测试策略，并主动在 `tests/` 目录下为其编写相应的 `pytest` 测试用例。
你生成的测试代码必须清晰、可读，并能覆盖正常逻辑、边界条件和异常情况。
在适当的时候，你需要主动使用 Mock 技术来隔离外部依赖，确保单元测试的独立性和速度。
-->

# 测试策略与规范 (Testing Strategy & Specification)

## 1. 测试理念 (Testing Philosophy)

- **质量是内建的**: 我们不把测试看作是开发后的一个阶段，而是开发过程中不可或缺的一部分。代码与其测试是一个整体。
- **测试金字塔**: 我们遵循经典的测试金字塔模型，将测试投入的重点放在底层。
  - **单元测试 (Unit Tests)**: 构成测试主体，保证单个组件的正确性。
  - **集成测试 (Integration Tests)**: 验证多个组件协同工作的正确性。
  - **端到端测试 (E2E Tests)**: 覆盖关键用户场景，数量最少。
- **测试驱动开发 (TDD)**: 鼓励采用“红-绿-重构”的 TDD 流程，这有助于编写出更简洁、更易于测试的代码。

---

## 2. 单元测试规范 (Unit Testing)

单元测试是我们的第一道防线，必须快速、稳定、可靠。

- **框架**: 项目统一使用 `pytest` 作为测试框架。
- **位置**: 所有测试代码必须存放在项目根目录的 `tests/` 文件夹下。测试文件的命名必须是 `*_test.py`。
- **测试对象**:
  - **公共接口**: 单元测试应主要针对模块或类的公共函数/方法。
  - **业务逻辑**: 重点测试包含复杂条件、循环和算法的核心业务逻辑。
  - **边界条件**: 必须包含对边界情况的测试（例如，输入为空、为零、为负数、或达到最大值）。
  - **异常情况**: 必须测试当输入无效或发生错误时，代码是否能按预期抛出正确的异常 (`pytest.raises`)。
- **隔离性**:
  - **禁止外部依赖**: 单元测试**严禁**依赖任何外部服务，如数据库、网络请求、文件系统等。
  - **使用 Mock**: 当被测代码依赖外部服务时，必须使用 `unittest.mock` (`pytest-mock` 插件) 来模拟这些依赖的行为，确保测试的确定性和速度。

---

## 3. 集成测试规范 (Integration Testing)

集成测试用于验证我们自己开发的多个模块在一起时能否正常工作。

- **定义**: 测试多个内部组件的交互。例如，测试一个 API 端点是否能正确调用服务层，服务层是否能正确与数据访问层交互。
- **Fixtures**: 优先使用 `pytest` 的 `fixtures` (`conftest.py`) 来准备和管理测试所需的环境和数据，例如提供一个临时的测试数据库连接或创建一个测试数据文件。
- **分离执行**: 集成测试应与单元测试分离，例如通过 `pytest` 的标记 (`@pytest.mark.integration`)，以便在 CI/CD 流水线中可以独立、快速地运行单元测试。

---

## 4. 代码覆盖率 (Code Coverage)

- **工具**: 必须使用 `pytest-cov` 插件来监控和报告代码覆盖率。
- **目标**:
  - **最低标准**: 整个项目的测试覆盖率不应低于 **80%**。
  - **新代码要求**: 所有新提交的功能代码，其行覆盖率必须达到 **90%** 以上。
- **报告生成**:
  - **CI/CD**: 在持续集成环境中，测试未通过或覆盖率未达标的合并请求将被阻止。
  - **本地检查**: 开发者应在本地频繁运行以下命令来检查覆盖率：
    ```bash
    uv run pytest --cov=src/[package_name] --cov-report=term-missing --cov-report=html
    ```
    这会生成一个可交互的 `htmlcov/` 报告，帮助定位未被测试覆盖的代码行。

---

## 5. AI 实施指南

当你为我编写新功能时，请：
1.  **主动询问测试数据**: 在编写任何测试用-例之前，你必须首先询问我：“是否可以为 `[功能名称]` 功能提供一个简单的、已知结果的测试数据样本？”。你应等待并使用我提供的数据来构建你的测试用例。
2.  **同步提供测试**: 在你交付位于 `src/` 目录下的任何 `.py` 文件时，必须在同一时间、同一响应中，提供一个位于 `tests/` 目录下的对应 `*_test.py` 文件。
3.  **遵循规范**: 你提供的测试代码必须严格遵守上述所有规范，包括命名、测试对象、隔离性和覆盖范围。
4.  **示例优先**: 在编写测试时，优先使用具体的、有业务含义的示例数据（尤其是我提供的），而不是随机或无意义的数据。
